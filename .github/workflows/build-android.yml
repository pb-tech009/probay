name: Build Android for Play Store

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      
      - name: Install dependencies
        run: |
          cd frontend
          npm install
      
      - name: Generate Android project
        run: |
          cd frontend
          npx expo prebuild --platform android --clean
      
      - name: Setup signing config
        run: |
          cd frontend/android/app
          cat > signing.properties << EOF
          PROPBAY_UPLOAD_STORE_FILE=propbay.keystore
          PROPBAY_UPLOAD_KEY_ALIAS=propbay
          PROPBAY_UPLOAD_STORE_PASSWORD=propbay123
          PROPBAY_UPLOAD_KEY_PASSWORD=propbay123
          EOF
      
      - name: Generate keystore
        run: |
          cd frontend/android/app
          keytool -genkeypair -v -storetype PKCS12 \
            -keystore propbay.keystore \
            -alias propbay \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass propbay123 \
            -keypass propbay123 \
            -dname "CN=PropBay, OU=Development, O=PropBay, L=Ahmedabad, ST=Gujarat, C=IN"
      
      - name: Update build.gradle for signing
        run: |
          cd frontend/android/app
          cat >> build.gradle << 'EOF'
          
          android {
              signingConfigs {
                  release {
                      storeFile file('propbay.keystore')
                      storePassword 'propbay123'
                      keyAlias 'propbay'
                      keyPassword 'propbay123'
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
      
      - name: Build AAB (Play Store)
        run: |
          cd frontend/android
          ./gradlew bundleRelease
      
      - name: Build APK (Testing)
        run: |
          cd frontend/android
          ./gradlew assembleRelease
      
      - name: Upload AAB (Play Store)
        uses: actions/upload-artifact@v3
        with:
          name: propbay-playstore-aab
          path: frontend/android/app/build/outputs/bundle/release/app-release.aab
      
      - name: Upload APK (Testing)
        uses: actions/upload-artifact@v3
        with:
          name: propbay-testing-apk
          path: frontend/android/app/build/outputs/apk/release/app-release.apk
